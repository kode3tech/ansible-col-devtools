---
# Tasks file for docker

- name: Set OS family variable for consistency
  ansible.builtin.set_fact:
    docker_os_family: "{{ 'RedHat' if ansible_os_family in ['RedHat', 'Rocky', 'AlmaLinux'] else ansible_os_family }}"
  tags: docker

- name: Include OS-specific variables
  ansible.builtin.include_vars: "{{ docker_os_family }}.yml"
  tags: docker

- name: Include OS-specific tasks
  ansible.builtin.include_tasks: "setup-{{ docker_os_family }}.yml"
  tags: docker

- name: Install docker-ce-rootless-extras (optional)
  ansible.builtin.package:
    name: docker-ce-rootless-extras
    state: present
  failed_when: false
  tags: docker

- name: Install crun for better performance (optional)
  ansible.builtin.package:
    name: crun
    state: present
  failed_when: false  # Don't fail if crun is not available
  tags: docker

- name: Ensure Docker daemon configuration directory exists
  ansible.builtin.file:
    path: "{{ docker_daemon_config_path | dirname }}"
    state: directory
    mode: '0755'
  tags: docker

- name: Merge Docker daemon configuration with insecure registries
  ansible.builtin.set_fact:
    _docker_daemon_config_merged: >-
      {{
        docker_daemon_config | combine(
          {'insecure-registries': docker_insecure_registries}
          if docker_insecure_registries | length > 0
          else {}
        )
      }}
  tags: docker

- name: Configure Docker daemon
  ansible.builtin.copy:
    content: "{{ _docker_daemon_config_merged | to_nice_json }}"
    dest: "{{ docker_daemon_config_path }}"
    mode: '0644'
  notify: restart docker
  when: _docker_daemon_config_merged | length > 0
  tags: docker

- name: Ensure Docker service is started and enabled
  ansible.builtin.service:
    name: docker
    state: "{{ docker_service_state }}"
    enabled: "{{ docker_service_enabled }}"
  tags: docker

- name: Add users to docker group
  ansible.builtin.user:
    name: "{{ item }}"
    groups: docker
    append: true
  loop: "{{ docker_users }}"
  when: docker_users | length > 0
  tags: docker

- name: Reset SSH connection to apply group changes
  ansible.builtin.meta: reset_connection
  when: docker_users | length > 0
  tags: docker

- name: Install Python requests library for docker_login
  ansible.builtin.package:
    name: python3-requests
    state: present
  when: docker_registries_auth | length > 0
  tags: docker-login

- name: Login to Docker registries
  community.docker.docker_login:
    registry_url: "{{ item.registry }}"
    username: "{{ item.username }}"
    password: "{{ item.password }}"
    email: "{{ item.email | default(omit) }}"
    reauthorize: true
  loop: "{{ docker_registries_auth }}"
  when: docker_registries_auth | length > 0
  no_log: true
  register: docker_login_result
  tags: docker-login

- name: Display Docker login warnings
  ansible.builtin.debug:
    msg: "Warning: Failed to login to registry {{ item.item.registry }} - check credentials"
  loop: "{{ docker_login_result.results | default([]) }}"
  when:
    - docker_registries_auth | length > 0
    - item.failed | default(false)
  tags: docker-login

- name: Login to Docker registries for each user
  community.docker.docker_login:
    registry_url: "{{ item.1.registry }}"
    username: "{{ item.1.username }}"
    password: "{{ item.1.password }}"
    email: "{{ item.1.email | default(omit) }}"
    reauthorize: true
    config_path: "/home/{{ item.0 }}/.docker/config.json"
  loop: "{{ docker_users | product(docker_registries_auth) | list }}"
  when:
    - docker_registries_auth | length > 0
    - docker_users | length > 0
  no_log: true
  register: docker_user_login_result
  tags: docker-login

- name: Display user Docker login warnings
  ansible.builtin.debug:
    msg: "Warning: Failed to login user {{ item.item.0 }} to registry {{ item.item.1.registry }} - check credentials"
  loop: "{{ docker_user_login_result.results | default([]) }}"
  when:
    - docker_registries_auth | length > 0
    - docker_users | length > 0
    - item.failed | default(false)
  tags: docker-login

# Docker permission fixes for all distributions (must run AFTER login tasks)
# These tasks fix ownership issues when config.json is created as root
- name: Create .docker directory for each user (permission fix)
  ansible.builtin.file:
    path: "/home/{{ item }}/.docker"
    state: directory
    owner: "{{ item }}"
    group: "{{ item }}"
    mode: '0700'
  loop: "{{ docker_users }}"
  when:
    - docker_users | length > 0
    - docker_registries_auth | length > 0
  tags: docker

- name: Fix Docker config file permissions for each user (permission fix)
  ansible.builtin.file:
    path: "/home/{{ item }}/.docker/config.json"
    owner: "{{ item }}"
    group: "{{ item }}"
    mode: '0600'
    state: file
  loop: "{{ docker_users }}"
  when:
    - docker_users | length > 0
    - docker_registries_auth | length > 0
  failed_when: false  # Don't fail if file doesn't exist
  tags: docker

- name: Restore SELinux context for Docker config directories (RedHat SELinux fix)
  ansible.builtin.command: restorecon -R "/home/{{ item }}/.docker/"
  loop: "{{ docker_users }}"
  when:
    - docker_users | length > 0
    - docker_registries_auth | length > 0
    - ansible_os_family in ['RedHat', 'Rocky', 'AlmaLinux']
    - ansible_selinux.status is defined
    - ansible_selinux.status == "enabled"
  failed_when: false  # Don't fail if SELinux is not available or directory doesn't exist
  changed_when: false  # This is a maintenance operation
  tags: docker
