---
# Tasks file for docker
- name: Set OS family variable for consistency
  ansible.builtin.set_fact:
    docker_os_family: "{{ 'RedHat' if ansible_os_family in ['RedHat', 'Rocky', 'AlmaLinux'] else ansible_os_family }}"
  tags: docker

- name: Include OS-specific tasks
  ansible.builtin.include_tasks: "setup-{{ docker_os_family }}.yml"
  tags: docker

- name: Install docker-ce-rootless-extras (optional)
  ansible.builtin.package:
    name: docker-ce-rootless-extras
    state: present
  failed_when: false
  tags: docker

- name: Install crun for better performance (optional)
  ansible.builtin.package:
    name: crun
    state: present
  failed_when: false
  tags: docker

- name: Ensure Docker daemon configuration directory exists
  ansible.builtin.file:
    path: "{{ docker_daemon_config_path | dirname }}"
    state: directory
    mode: '0755'
  tags: docker

- name: Merge Docker daemon configuration with insecure registries
  ansible.builtin.set_fact:
    _docker_daemon_config_merged: >-
      {{
        docker_daemon_config | combine(
          {'insecure-registries': docker_insecure_registries}
          if docker_insecure_registries | length > 0
          else {}
        )
      }}
  tags: docker

- name: Configure Docker daemon
  ansible.builtin.copy:
    content: "{{ _docker_daemon_config_merged | to_nice_json }}"
    dest: "{{ docker_daemon_config_path }}"
    mode: '0644'
  notify: restart docker
  when: _docker_daemon_config_merged | length > 0
  tags: docker

- name: Ensure Docker service is started and enabled
  ansible.builtin.service:
    name: docker
    state: "{{ docker_service_state }}"
    enabled: "{{ docker_service_enabled }}"
  tags: docker

- name: Add users to docker group
  ansible.builtin.user:
    name: "{{ item }}"
    groups: docker
    append: true
  loop: "{{ docker_users }}"
  when: docker_users | length > 0
  tags: docker

- name: Reset SSH connection to apply group changes
  ansible.builtin.meta: reset_connection
  when: docker_users | length > 0
  tags: docker

- name: Install Python requests library for docker_login
  ansible.builtin.package:
    name: python3-requests
    state: present
  when: docker_registries_auth | length > 0
  tags: docker-login

- name: Login to Docker registries
  community.docker.docker_login:
    registry_url: "{{ item.registry }}"
    username: "{{ item.username }}"
    password: "{{ item.password }}"
    email: "{{ item.email | default(omit) }}"
    reauthorize: true
  loop: "{{ docker_registries_auth }}"
  when: docker_registries_auth | length > 0
  no_log: true
  tags: docker-login

- name: Login to Docker registries for each user
  community.docker.docker_login:
    registry_url: "{{ item.1.registry }}"
    username: "{{ item.1.username }}"
    password: "{{ item.1.password }}"
    email: "{{ item.1.email | default(omit) }}"
    reauthorize: true
    config_path: "/home/{{ item.0 }}/.docker/config.json"
  loop: "{{ docker_users | product(docker_registries_auth) | list }}"
  when:
    - docker_registries_auth | length > 0
    - docker_users | length > 0
  no_log: true
  tags: docker-login

# Docker permission fixes for all distributions (must run AFTER login tasks)
# These tasks fix ownership issues when config.json is created as root
- name: Fix Docker config permissions for users
  ansible.builtin.include_tasks:
    file: "{{ role_path }}/../../plugins/shared_tasks/permission_fixes.yml"
  vars:
    container_users: "{{ docker_users }}"
    container_config_paths: ['.docker']
    container_config_files: ['.docker/config.json']
  when:
    - docker_users | length > 0
    - docker_registries_auth | length > 0
  tags: docker
