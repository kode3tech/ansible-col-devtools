---
# Verify playbook for gitlab_ci_runners role testing
# Validates the role installation, configuration, and removal

- name: Verify gitlab_ci_runners role
  hosts: all
  gather_facts: true

  vars:
    # Runners that should exist after converge
    runners_to_verify:
      - name: "test-runner-01"
      - name: "test-runner-02"

    # Runner that should have been removed
    runner_removed: "test-runner-03"

  tasks:
    # =========================================================================
    # Verify GitLab Runner Package and Binary
    # =========================================================================
    - name: Verify gitlab-runner binary is present
      ansible.builtin.command:
        argv:
          - gitlab-runner
          - --version
      register: runner_version
      changed_when: false

    - name: Assert gitlab-runner version command succeeded
      ansible.builtin.assert:
        that:
          - runner_version.rc == 0
          - "'gitlab-runner' in runner_version.stdout or 'Version' in runner_version.stdout"
        fail_msg: "GitLab Runner binary not found or not working"
        success_msg: "✅ GitLab Runner binary is present and working"

    # =========================================================================
    # Note: Service verification skipped in Molecule Docker environment
    # systemd is not fully functional in Docker containers
    # Service is verified in real deployments via main.yml tasks
    # =========================================================================

    # =========================================================================
    # Verify User and Group
    # =========================================================================
    - name: Verify runner user exists
      ansible.builtin.getent:
        database: passwd
        key: gitlab-runner
      register: runner_user

    - name: Assert runner user was created
      ansible.builtin.assert:
        that:
          - runner_user is succeeded
        fail_msg: "Runner user 'gitlab-runner' was not created"
        success_msg: "✅ Runner user 'gitlab-runner' exists"

    - name: Verify runner group exists
      ansible.builtin.getent:
        database: group
        key: gitlab-runner
      register: runner_group

    - name: Assert runner group was created
      ansible.builtin.assert:
        that:
          - runner_group is succeeded
        fail_msg: "Runner group 'gitlab-runner' was not created"
        success_msg: "✅ Runner group 'gitlab-runner' exists"

    # =========================================================================
    # Verify Base Directory
    # =========================================================================
    - name: Verify base directory exists
      ansible.builtin.stat:
        path: /opt/gitlab-ci-runners
      register: base_dir

    - name: Assert base directory was created
      ansible.builtin.assert:
        that:
          - base_dir.stat.exists
          - base_dir.stat.isdir
          - base_dir.stat.pw_name == 'gitlab-runner'
        fail_msg: "Base directory /opt/gitlab-ci-runners was not properly created"
        success_msg: "✅ Base directory exists with correct ownership"

    # =========================================================================
    # Verify Config Directory
    # =========================================================================
    - name: Verify config directory exists
      ansible.builtin.stat:
        path: /etc/gitlab-runner
      register: config_dir

    - name: Assert config directory exists
      ansible.builtin.assert:
        that:
          - config_dir.stat.exists
          - config_dir.stat.isdir
        fail_msg: "Config directory /etc/gitlab-runner was not created"
        success_msg: "✅ Config directory exists"

    # =========================================================================
    # Verify Runner Directories (should exist)
    # =========================================================================
    - name: Verify runner directories exist
      ansible.builtin.stat:
        path: "/opt/gitlab-ci-runners/{{ item.name }}"
      loop: "{{ runners_to_verify }}"
      loop_control:
        label: "{{ item.name }}"
      register: runner_dirs

    - name: Assert all runner directories were created
      ansible.builtin.assert:
        that:
          - item.stat.exists
          - item.stat.isdir
        fail_msg: "Runner directory {{ item.item.name }} was not created"
        success_msg: "✅ Runner directory {{ item.item.name }} exists"
      loop: "{{ runner_dirs.results }}"
      loop_control:
        label: "{{ item.item.name }}"

    # =========================================================================
    # Verify Runner Subdirectories (builds, cache)
    # =========================================================================
    - name: Verify runner builds directories exist
      ansible.builtin.stat:
        path: "/opt/gitlab-ci-runners/{{ item.name }}/builds"
      loop: "{{ runners_to_verify }}"
      loop_control:
        label: "{{ item.name }}"
      register: builds_dirs

    - name: Assert builds directories were created
      ansible.builtin.assert:
        that:
          - item.stat.exists
          - item.stat.isdir
        fail_msg: "Builds directory for {{ item.item.name }} was not created"
        success_msg: "✅ Builds directory for {{ item.item.name }} exists"
      loop: "{{ builds_dirs.results }}"
      loop_control:
        label: "{{ item.item.name }}"

    - name: Verify runner cache directories exist
      ansible.builtin.stat:
        path: "/opt/gitlab-ci-runners/{{ item.name }}/cache"
      loop: "{{ runners_to_verify }}"
      loop_control:
        label: "{{ item.name }}"
      register: cache_dirs

    - name: Assert cache directories were created
      ansible.builtin.assert:
        that:
          - item.stat.exists
          - item.stat.isdir
        fail_msg: "Cache directory for {{ item.item.name }} was not created"
        success_msg: "✅ Cache directory for {{ item.item.name }} exists"
      loop: "{{ cache_dirs.results }}"
      loop_control:
        label: "{{ item.item.name }}"

    # =========================================================================
    # Verify Runner Removal (should NOT exist)
    # =========================================================================
    - name: Verify removed runner directory does NOT exist
      ansible.builtin.stat:
        path: "/opt/gitlab-ci-runners/{{ runner_removed }}"
      register: removed_runner_dir

    - name: Assert removed runner directory was deleted
      ansible.builtin.assert:
        that:
          - not removed_runner_dir.stat.exists
        fail_msg: "Runner directory {{ runner_removed }} should have been removed but still exists"
        success_msg: "✅ Runner directory {{ runner_removed }} was successfully removed"

    # =========================================================================
    # Verify Prerequisite Packages
    # =========================================================================
    - name: Verify prerequisite packages are installed (Debian)
      ansible.builtin.package:
        name:
          - ca-certificates
        state: present
      check_mode: true
      register: prereq_check_debian
      when: ansible_os_family == 'Debian'

    - name: Verify prerequisite packages are installed (RedHat)
      ansible.builtin.package:
        name:
          - ca-certificates
          - curl
        state: present
      check_mode: true
      register: prereq_check_redhat
      when: ansible_os_family in ['RedHat', 'Rocky', 'AlmaLinux']

    - name: Assert prerequisites are installed
      ansible.builtin.assert:
        that:
          - (prereq_check_debian is defined and not prereq_check_debian.changed) or
            (prereq_check_redhat is defined and not prereq_check_redhat.changed)
        fail_msg: "Prerequisite packages are not installed"
        success_msg: "✅ All prerequisite packages are installed"

    # =========================================================================
    # Summary
    # =========================================================================
    - name: Display verification summary
      ansible.builtin.debug:
        msg:
          - "═══════════════════════════════════════════════════════════"
          - "           VERIFICATION COMPLETED SUCCESSFULLY             "
          - "═══════════════════════════════════════════════════════════"
          - ""
          - "✅ GitLab Runner package installed and binary working"
          - "✅ Runner user and group created"
          - "✅ Base directory created with correct permissions"
          - "✅ Config directory exists"
          - "✅ {{ runners_to_verify | length }} runner directories created and verified"
          - "✅ Builds and cache subdirectories exist for each runner"
          - "✅ 1 runner directory removed ({{ runner_removed }})"
          - "✅ Prerequisite packages installed"
          - ""
          - "Tested scenarios:"
          - "  - Multi-runner installation (3 runners)"
          - "  - Runner removal with state: absent"
          - "  - Directory cleanup on removal"
          - "  - Isolated directory structure (no root builds/cache)"
          - ""
          - "Note: Service verification skipped (Docker limitation)"
          - "      Service is verified in real deployments"
          - ""
          - "Note: Full runner registration/unregistration tests"
          - "      require valid GitLab credentials and API access"
          - "═══════════════════════════════════════════════════════════"
