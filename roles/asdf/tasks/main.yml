---
# Main task file for asdf role - Clean, modular approach
# 1. Base Installation (binary, prerequisites, PATH)
# 2. Plugins and Versions (centralized management)
# 3. Users and Group (asdf group with shared permissions)

# =============================================================================
# STAGE 1: BASE INSTALLATION
# =============================================================================
- name: Include OS-specific variables
  ansible.builtin.include_vars: >-
    {{ 'RedHat' if ansible_os_family in ['RedHat', 'Rocky', 'AlmaLinux'] else ansible_os_family }}.yml
  tags:
    - asdf
    - installation

- name: Include OS-specific setup tasks
  ansible.builtin.include_tasks: >-
    setup-{{ 'RedHat' if ansible_os_family in ['RedHat', 'Rocky', 'AlmaLinux'] else ansible_os_family }}.yml
  tags:
    - asdf
    - installation

- name: Create asdf installation directory
  ansible.builtin.file:
    path: "{{ asdf_install_dir }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
  tags:
    - asdf
    - installation

- name: Install asdf binary
  ansible.builtin.include_tasks: install-binary.yml
  tags:
    - asdf
    - installation

- name: Configure system-wide PATH for asdf
  ansible.builtin.template:
    src: asdf-system.sh.j2
    dest: /etc/profile.d/asdf.sh
    mode: '0644'
    owner: root
    group: root
  tags:
    - asdf
    - installation

- name: Validate asdf installation
  ansible.builtin.command:
    cmd: "{{ asdf_install_dir }}/bin/asdf version"
  register: asdf_version_check
  changed_when: false
  tags:
    - asdf
    - installation
    - validation

# =============================================================================
# STAGE 2: PLUGINS AND VERSIONS
# =============================================================================
- name: Create asdf group for shared access
  ansible.builtin.group:
    name: asdf
    state: present
  when: asdf_users | length > 0
  tags:
    - asdf
    - users

- name: Set asdf directory ownership to asdf group
  ansible.builtin.file:
    path: "{{ asdf_install_dir }}"
    group: asdf
    mode: '0775'
    recurse: true
  when: asdf_users | length > 0
  tags:
    - asdf
    - users

- name: Install asdf plugins (centralized)
  ansible.builtin.command:
    cmd: "{{ asdf_install_dir }}/bin/asdf plugin add {{ item.name }}"
  environment:
    ASDF_DATA_DIR: "{{ asdf_data_dir if asdf_data_dir else asdf_install_dir }}"
  loop: "{{ asdf_plugins }}"
  register: asdf_plugin_install
  changed_when: asdf_plugin_install.rc == 0 and 'already added' not in asdf_plugin_install.stderr
  failed_when:
    - asdf_plugin_install.rc != 0
    - "'already added' not in asdf_plugin_install.stderr"
  when: asdf_plugins | length > 0
  tags:
    - asdf
    - plugins

- name: Install plugin versions (centralized)
  ansible.builtin.command:
    cmd: "{{ asdf_install_dir }}/bin/asdf install {{ item.0.name }} {{ item.1 }}"
  environment:
    ASDF_DATA_DIR: "{{ asdf_data_dir if asdf_data_dir else asdf_install_dir }}"
  loop: "{{ asdf_plugins | subelements('versions', skip_missing=True) }}"
  loop_control:
    label: "{{ item.0.name }} {{ item.1 }}"
  register: asdf_version_install
  changed_when: "'already installed' not in asdf_version_install.stderr"
  failed_when:
    - asdf_version_install.rc != 0
    - "'already installed' not in asdf_version_install.stderr"
  when: asdf_plugins | length > 0
  tags:
    - asdf
    - plugins

- name: Set global versions for plugins
  ansible.builtin.command:
    cmd: "{{ asdf_install_dir }}/bin/asdf set {{ item.name }} {{ item.global }}"
  environment:
    ASDF_DATA_DIR: "{{ asdf_data_dir if asdf_data_dir else asdf_install_dir }}"
  loop: "{{ asdf_plugins }}"
  loop_control:
    label: "{{ item.name }} -> {{ item.global }}"
  when:
    - asdf_plugins | length > 0
    - item.global is defined
  register: asdf_global_set
  changed_when: asdf_global_set.rc == 0
  tags:
    - asdf
    - plugins

# =============================================================================
# STAGE 3: USERS AND GROUP ACCESS
# =============================================================================
- name: Get user information for home directory detection
  ansible.builtin.getent:
    database: passwd
    key: "{{ item }}"
  loop: "{{ asdf_users }}"
  when: asdf_users | length > 0
  register: asdf_user_info
  tags:
    - asdf
    - users
    - validation

- name: Validate that users exist on the system
  ansible.builtin.assert:
    that:
      - item.ansible_facts.getent_passwd[item.item] is defined
    fail_msg: "User {{ item.item }} does not exist on the system"
    success_msg: "User {{ item.item }} exists"
  loop: "{{ asdf_user_info.results }}"
  when:
    - asdf_users | length > 0
    - not item.skipped | default(false)
  tags:
    - asdf
    - users
    - validation

- name: Add users to asdf group
  ansible.builtin.user:
    name: "{{ item }}"
    groups: asdf
    append: true
  loop: "{{ asdf_users }}"
  when: asdf_users | length > 0
  tags:
    - asdf
    - users

- name: Configure asdf in user shell profiles
  ansible.builtin.blockinfile:
    path: "{{ item.ansible_facts.getent_passwd[item.item][4] }}/.{{ asdf_shell_profile }}"
    block: |
      # asdf version manager configuration
      export PATH="{{ asdf_install_dir }}/shims:$PATH"
      {% if asdf_data_dir %}
      export ASDF_DATA_DIR="{{ asdf_data_dir }}"
      {% endif %}
    marker: "# {mark} ANSIBLE MANAGED BLOCK - asdf"
    create: true
    owner: "{{ item.item }}"
    group: "{{ item.item }}"
    mode: '0644'
  loop: "{{ asdf_user_info.results }}"
  when:
    - asdf_users | length > 0
    - asdf_configure_shell | bool
    - not item.skipped | default(false)
  tags:
    - asdf
    - users
