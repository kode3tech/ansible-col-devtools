# Ansible Role: asdf

Ansible role for installing and configuring asdf version manager for managing multiple runtime versions.

## Requirements

- Ansible >= 2.15
- Target system: Ubuntu 22.04+, Debian 11+, or RHEL 9+
- Root or sudo privileges on target hosts
- Internet connection for downloading asdf and plugins

### Supported Distributions

- **Ubuntu**: 22.04 (Jammy), 24.04 (Noble), 25.04 (Plucky)
- **Debian**: 11 (Bullseye), 12 (Bookworm), 13 (Trixie)
- **RHEL/CentOS/Rocky/AlmaLinux**: 9, 10

## Role Variables

Available variables are listed below, along with default values (see `defaults/main.yml`):

```yaml
# asdf installation method: 'binary' (recommended) or 'git' (legacy)
asdf_install_method: "binary"

# asdf version to install (latest by default)
# For binary: use release tag like 'v0.14.1' or 'latest'
# For git: use branch/tag like 'master' or 'v0.14.1'
asdf_version: "latest"

# asdf installation directory
asdf_install_dir: "/opt/asdf"

# asdf binary download URL (for binary installation method)
asdf_binary_url: "https://github.com/asdf-vm/asdf/releases/download"

# Git repository URL for asdf (for git installation method)
asdf_git_repo: "https://github.com/asdf-vm/asdf.git"

# Custom data directory (optional)
# Set to customize where asdf stores plugins, installs, and shims
# Default: ~/.asdf (for per-user) or /opt/asdf (for system-wide)
asdf_data_dir: ""

# Users who should have asdf configured in their shell
asdf_users: []

# Shell configurations to update (.bashrc, .zshrc, etc.)
asdf_configure_shell: true

# Shell profile files by shell type
asdf_shell_profiles:
  bash: ".bashrc"
  zsh: ".zshrc"
  fish: ".config/fish/config.fish"

# asdf plugins to install
asdf_plugins: []
# Example:
#   - name: "nodejs"
#     versions:
#       - "20.10.0"
#     global: "20.10.0"
#   - name: "python"
#     versions:
#       - "3.11.6"
#     global: "3.11.6"

# System dependencies required for asdf
asdf_install_dependencies: true

# Service state (asdf doesn't have a service, but kept for consistency)
asdf_service_enabled: false
asdf_service_state: stopped
```

### Installation Methods

This role supports two installation methods:

#### Binary Installation (Recommended - Default)

The **binary installation method** downloads a pre-compiled asdf binary from GitHub releases. This is the recommended method for asdf v0.16.0+.

**Advantages:**
- ✅ Faster installation (no git clone needed)
- ✅ Smaller footprint (single binary vs. full repository)
- ✅ No git dependency required
- ✅ Official method recommended by asdf maintainers

**Usage:**
```yaml
asdf_install_method: "binary"  # Default
asdf_version: "latest"         # or specific version like "v0.14.1"
```

#### Git Installation (Legacy)

The **git installation method** clones the asdf repository from GitHub. This is the traditional installation method.

**Advantages:**
- ✅ Works with older asdf versions
- ✅ Access to development branches
- ✅ Easy to switch versions via git

**Usage:**
```yaml
asdf_install_method: "git"
asdf_version: "master"  # or specific tag like "v0.13.1"
```

### Shell Configuration

This role automatically configures asdf for user shells following [official asdf documentation](https://asdf-vm.com/guide/getting-started.html). The configuration differs based on:

1. **Installation Method** (binary vs. git)
2. **Shell Type** (bash, zsh, fish)

#### Supported Shells

- **Bash** (`.bashrc`)
- **ZSH** (`.zshrc`)
- **Fish** (`.config/fish/config.fish`)

#### Configuration Details

**For Binary Installation:**
- Adds asdf shims directory to `PATH`
- Sets up shell completions
- Supports custom `ASDF_DATA_DIR` configuration

**For Git Installation:**
- Sources asdf initialization scripts
- Sources shell-specific completion scripts
- Supports custom `ASDF_DATA_DIR` configuration

**Important Notes:**
- asdf scripts are sourced **after** `$PATH` is set
- asdf scripts are sourced **after** shell frameworks (oh-my-zsh, etc.)
- Shell configuration is added with ANSIBLE MANAGED BLOCK markers
- Users must restart their shell or source configuration after installation

#### Custom Data Directory

You can customize where asdf stores plugins, installs, and shims:

```yaml
asdf_data_dir: "/custom/path/to/asdf/data"
```

This is useful for:
- Shared storage in multi-user environments
- Custom mount points
- Network storage locations

### User Configuration

The `asdf_users` variable allows you to configure asdf for specific users with their plugins:

```yaml
asdf_users:
  - name: "deploy"
    home: "/home/deploy"
    shell: "bash"
    plugins:
      - name: "nodejs"
        versions:
          - "20.10.0"
          - "18.18.0"
        global: "20.10.0"
      - name: "python"
        versions:
          - "3.11.6"
        global: "3.11.6"
  - name: "developer"
    home: "/home/developer"
    shell: "zsh"
    plugins:
      - name: "ruby"
        versions:
          - "3.2.2"
        global: "3.2.2"
```

## Dependencies

None.

## Example Playbook

Basic installation (using binary method - default):

```yaml
- hosts: development_servers
  become: true
  roles:
    - kode3tech.devtools.asdf
```

Using git installation method:

```yaml
- hosts: development_servers
  become: true
  vars:
    asdf_install_method: "git"
    asdf_version: "master"
  roles:
    - kode3tech.devtools.asdf
```

With user configuration and plugins (binary method):

```yaml
- hosts: development_servers
  become: true
  vars:
    asdf_install_method: "binary"  # Recommended
    asdf_version: "latest"
    asdf_users:
      - name: "deploy"
        home: "/home/deploy"
        shell: "bash"
        plugins:
          - name: "nodejs"
            versions:
              - "20.10.0"
            global: "20.10.0"
  roles:
    - kode3tech.devtools.asdf
```

Advanced configuration with multiple users and plugins:

```yaml
- hosts: development_servers
  become: true
  vars:
    asdf_install_method: "binary"
    asdf_version: "v0.14.1"  # Specific version
    asdf_install_dir: "/opt/asdf"
    asdf_users:
      - name: "deploy"
        home: "/home/deploy"
        shell: "bash"
        plugins:
          - name: "nodejs"
            versions:
              - "20.10.0"
              - "18.18.0"
            global: "20.10.0"
          - name: "python"
            versions:
              - "3.11.6"
              - "3.10.13"
            global: "3.11.6"
      - name: "developer"
        home: "/home/developer"
        shell: "zsh"
        plugins:
          - name: "ruby"
            versions:
              - "3.2.2"
            global: "3.2.2"
          - name: "golang"
            versions:
              - "1.21.4"
            global: "1.21.4"
  roles:
    - kode3tech.devtools.asdf
```

## Supported Languages/Tools

asdf supports hundreds of plugins for different languages and tools. Common examples include:

- **Languages**: Node.js, Python, Ruby, Golang, Java, Rust, Elixir, Erlang, PHP
- **Tools**: Terraform, kubectl, helm, awscli, and many more

Visit [asdf plugins](https://github.com/asdf-vm/asdf-plugins) for the complete list.

## Post-Installation

After the role runs, users will need to:

1. **Restart their shell** or source their shell configuration:
   ```bash
   source ~/.bashrc  # for bash
   source ~/.zshrc   # for zsh
   ```

2. **Verify asdf installation**:
   ```bash
   asdf --version
   ```

3. **Check installed plugins**:
   ```bash
   asdf plugin list
   asdf list all nodejs  # List all available nodejs versions
   ```

## Testing

This role includes Molecule tests. To run tests:

```bash
cd roles/asdf
molecule test
```

To test on a specific platform:

```bash
molecule test --platform-name ubuntu2204
molecule test --platform-name debian12
molecule test --platform-name rockylinux9
```

## Troubleshooting

### Shell Configuration Not Working

If asdf commands are not found after installation:

1. Check if shell configuration was updated:
   ```bash
   grep -A 2 "asdf version manager" ~/.bashrc
   ```

2. Manually source the configuration:
   ```bash
   source ~/.bashrc
   ```

3. Verify asdf installation:
   ```bash
   ls -la /opt/asdf
   ```

### Plugin Installation Fails

If plugin installation fails:

1. Check system dependencies are installed:
   ```bash
   # Debian/Ubuntu
   dpkg -l | grep -E "git|curl|build-essential"
   
   # RHEL/Rocky
   rpm -qa | grep -E "git|curl|gcc"
   ```

2. Manually test plugin installation:
   ```bash
   /opt/asdf/bin/asdf plugin add nodejs
   /opt/asdf/bin/asdf list all nodejs
   ```

### Permission Issues

If you encounter permission errors:

1. Verify directory ownership:
   ```bash
   ls -la /opt/asdf
   ```

2. Check user home directory permissions:
   ```bash
   ls -la /home/username
   ```

## Performance Considerations

- **Installation Time**: First-time plugin installations can take several minutes as they compile from source
- **Disk Space**: Each language version is installed separately, plan for adequate disk space
- **System Dependencies**: Ensure all required build tools are installed (automatically handled by this role)

## Security Considerations

- asdf installs from official GitHub repository
- Each plugin is maintained by the community - review plugin sources before use
- Versions are downloaded from official language repositories
- Shell configurations are added with clear markers for easy identification

## License

MIT

## Author Information

This role was created by the **Kode3Tech DevOps Team**.

- GitHub: [kode3tech](https://github.com/kode3tech)
- Repository: [ansible-col-devtools](https://github.com/kode3tech/ansible-col-devtools)
