---
# Converge playbook for github_actions_runners role testing
# Tests the role installation without actual GitHub registration

- name: Converge - Test github_actions_runners role (Installation)
  hosts: all
  gather_facts: true

  vars:
    # Test configuration - uses mock values
    # Real registration would require valid GitHub credentials
    github_actions_runners_token: "mock-github-token-for-molecule-testing"
    github_actions_runners_scope: "organization"
    github_actions_runners_organization: "test-organization"
    github_actions_runners_base_path: "/opt/github-actions-runners"
    github_actions_runners_user: "ghrunner"
    github_actions_runners_group: "ghrunner"

    # Test with multiple runners
    github_actions_runners_list:
      - name: "test-runner-01"
        labels:
          - "self-hosted"
          - "linux"
          - "x64"

      - name: "test-runner-02"
        labels:
          - "docker"
          - "nodejs"

      - name: "test-runner-03"
        labels:
          - "python"

      # Runner to be removed in the next play
      - name: "test-runner-to-remove"
        labels:
          - "legacy"

  tasks:
    # Test prerequisites installation only (skip actual runner configuration)
    - name: Set OS family variable for consistency
      ansible.builtin.set_fact:
        github_actions_runners_os_family: >-
          {{ 'RedHat' if ansible_os_family in ['RedHat', 'Rocky', 'AlmaLinux'] else ansible_os_family }}

    - name: Include OS-specific variables
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../../vars/{{ github_actions_runners_os_family }}.yml"

    - name: Include OS-specific setup tasks
      ansible.builtin.include_tasks:
        file: "{{ playbook_dir }}/../../tasks/setup-{{ github_actions_runners_os_family }}.yml"

    - name: Test user and group creation
      block:
        - name: Ensure runner group exists
          ansible.builtin.group:
            name: "ghrunner"
            state: present
            system: true

        - name: Ensure runner user exists
          ansible.builtin.user:
            name: "ghrunner"
            group: "ghrunner"
            home: "/opt/github-actions-runners"
            shell: /bin/bash
            system: true
            create_home: true
            state: present

    - name: Create base directory for runners
      ansible.builtin.file:
        path: "/opt/github-actions-runners"
        state: directory
        owner: "ghrunner"
        group: "ghrunner"
        mode: '0755'

    - name: Create downloads directory
      ansible.builtin.file:
        path: "/opt/github-actions-runners/.downloads"
        state: directory
        owner: "ghrunner"
        group: "ghrunner"
        mode: '0755'

    - name: Create runner directories (simulating multi-runner)
      ansible.builtin.file:
        path: "/opt/github-actions-runners/{{ item.name }}"
        state: directory
        owner: "ghrunner"
        group: "ghrunner"
        mode: '0755'
      loop: "{{ github_actions_runners_list }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Create mock config.sh for removal testing
      ansible.builtin.copy:
        content: |
          #!/bin/bash
          # Mock config.sh for testing runner removal
          echo "Mock config.sh called with args: $@"
          exit 0
        dest: "/opt/github-actions-runners/{{ item.name }}/config.sh"
        owner: "ghrunner"
        group: "ghrunner"
        mode: '0755'
      loop: "{{ github_actions_runners_list }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Create mock svc.sh for removal testing
      ansible.builtin.copy:
        content: |
          #!/bin/bash
          # Mock svc.sh for testing service management
          echo "Mock svc.sh called with args: $@"
          exit 0
        dest: "/opt/github-actions-runners/{{ item.name }}/svc.sh"
        owner: "ghrunner"
        group: "ghrunner"
        mode: '0755'
      loop: "{{ github_actions_runners_list }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Create .runner marker file (simulates configured runner)
      ansible.builtin.copy:
        content: |
          {
            "agentId": 12345,
            "agentName": "{{ item.name }}",
            "poolId": 1
          }
        dest: "/opt/github-actions-runners/{{ item.name }}/.runner"
        owner: "ghrunner"
        group: "ghrunner"
        mode: '0644'
      loop: "{{ github_actions_runners_list }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Display installation test summary
      ansible.builtin.debug:
        msg:
          - "Phase 1: Installation test completed"
          - "Tested runner directories: {{ github_actions_runners_list | map(attribute='name') | list }}"

# =============================================================================
# Phase 2: Test runner removal functionality
# =============================================================================
- name: Converge - Test github_actions_runners role (Removal)
  hosts: all
  gather_facts: true

  vars:
    github_actions_runners_token: "mock-github-token-for-molecule-testing"
    github_actions_runners_scope: "organization"
    github_actions_runners_organization: "test-organization"
    github_actions_runners_base_path: "/opt/github-actions-runners"
    github_actions_runners_user: "ghrunner"
    github_actions_runners_group: "ghrunner"
    github_actions_runners_delete_on_remove: true

    # Test per-runner state removal
    github_actions_runners_list:
      - name: "test-runner-01"
        labels:
          - "self-hosted"
          - "linux"
        state: present  # Keep this runner

      - name: "test-runner-02"
        labels:
          - "docker"
          - "nodejs"
        state: present  # Keep this runner

      - name: "test-runner-03"
        labels:
          - "python"
        state: present  # Keep this runner

      - name: "test-runner-to-remove"
        labels:
          - "legacy"
        state: absent  # REMOVE this runner

  tasks:
    - name: Set OS family variable for consistency
      ansible.builtin.set_fact:
        github_actions_runners_os_family: >-
          {{ 'RedHat' if ansible_os_family in ['RedHat', 'Rocky', 'AlmaLinux'] else ansible_os_family }}

    - name: Include OS-specific variables
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../../vars/{{ github_actions_runners_os_family }}.yml"

    # Simulate removal by filtering runners
    - name: "Filter runners to remove (state: absent)"
      ansible.builtin.set_fact:
        _runners_to_remove: >-
          {{ github_actions_runners_list
             | selectattr('state', 'defined')
             | selectattr('state', 'equalto', 'absent')
             | list }}
        _runners_to_keep: >-
          {{ github_actions_runners_list | rejectattr('state', 'defined') | list +
             github_actions_runners_list
             | selectattr('state', 'defined')
             | selectattr('state', 'equalto', 'present')
             | list }}

    - name: Display runners categorization
      ansible.builtin.debug:
        msg:
          - "Runners to keep: {{ _runners_to_keep | map(attribute='name') | list }}"
          - "Runners to remove: {{ _runners_to_remove | map(attribute='name') | list }}"

    # Simulate runner removal (without calling real GitHub API)
    # In real scenarios, remove-runner.yml would unregister from GitHub
    # For Molecule testing, we just remove the directory to test the flow
    - name: Simulate runner removal (delete directory only - no API call)
      ansible.builtin.file:
        path: "/opt/github-actions-runners/{{ item.name }}"
        state: absent
      loop: "{{ _runners_to_remove }}"
      loop_control:
        label: "{{ item.name }}"
      when: _runners_to_remove | length > 0

    - name: Display removal test summary
      ansible.builtin.debug:
        msg:
          - "Phase 2: Removal test completed"
          - "Runners removed: {{ _runners_to_remove | map(attribute='name') | list }}"
          - "Runners kept: {{ _runners_to_keep | map(attribute='name') | list }}"
          - "Note: Actual runner unregistration requires valid GitHub credentials"
          - "      (Molecule test simulates removal by deleting directory only)"
