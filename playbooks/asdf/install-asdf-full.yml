---
# Advanced asdf installation with heavy plugins for production testing
# Plugins: nodejs, python (requires compilation, longer installation)
# Use this for comprehensive tests and production environments

- name: Install asdf with nodejs and python
  hosts: all
  become: true

  vars:
    asdf_version: "latest"
    asdf_install_dir: "/opt/asdf"
    asdf_install_dependencies: true
    asdf_configure_shell: true

    # Heavy plugins for production (installation time: ~5-15 minutes)
    asdf_users:
      - name: "{{ ansible_user }}"
        shell: "bash"
        plugins:
          # Node.js - JavaScript runtime
          # Installation: ~3-8 minutes per version (download + compile)
          - name: "nodejs"
            versions:
              - "20.11.0"
              - "18.19.0"
            global: "20.11.0"

          # Python - Programming language
          # Installation: ~2-7 minutes per version (download + compile)
          - name: "python"
            versions:
              - "3.12.1"
              - "3.11.7"
            global: "3.12.1"

  roles:
    - role: asdf
      tags: asdf

  post_tasks:
    - name: Verify asdf installation
      ansible.builtin.command: "{{ asdf_install_dir }}/bin/asdf --version"
      register: asdf_version_check
      changed_when: false
      tags: verify

    - name: List installed plugins
      ansible.builtin.command: asdf plugin list
      register: asdf_plugins
      become_user: "{{ ansible_user }}"
      changed_when: false
      tags: verify

    - name: Check nodejs version
      ansible.builtin.command: node --version
      register: node_version
      become_user: "{{ ansible_user }}"
      environment:
        PATH: "{{ ansible_env.HOME }}/.asdf/shims:{{ ansible_env.PATH }}"
      changed_when: false
      tags: verify

    - name: Check python version
      ansible.builtin.command: python --version
      register: python_version
      become_user: "{{ ansible_user }}"
      environment:
        PATH: "{{ ansible_env.HOME }}/.asdf/shims:{{ ansible_env.PATH }}"
      changed_when: false
      tags: verify

    - name: Test nodejs functionality
      ansible.builtin.command: node -e "console.log('Hello from Node.js')"
      register: node_test
      become_user: "{{ ansible_user }}"
      environment:
        PATH: "{{ ansible_env.HOME }}/.asdf/shims:{{ ansible_env.PATH }}"
      changed_when: false
      tags: verify

    - name: Test python functionality
      ansible.builtin.command: python -c "print('Hello from Python')"
      register: python_test
      become_user: "{{ ansible_user }}"
      environment:
        PATH: "{{ ansible_env.HOME }}/.asdf/shims:{{ ansible_env.PATH }}"
      changed_when: false
      tags: verify

    - name: Display installation summary
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "  asdf Installation Summary"
          - "========================================="
          - "✅ asdf version: {{ asdf_version_check.stdout }}"
          - "✅ Installed plugins: {{ asdf_plugins.stdout_lines | join(', ') }}"
          - "✅ Node.js: {{ node_version.stdout }}"
          - "✅ Python: {{ python_version.stdout }}"
          - "========================================="
          - "Functionality Tests:"
          - "  Node.js: {{ node_test.stdout }}"
          - "  Python: {{ python_test.stdout }}"
          - "========================================="
      tags: verify
