---
# Basic asdf installation with lightweight plugins for quick testing (v2.0 - Centralized)
# Plugins: direnv, jq (fast installation, no compilation)
# Use this for quick tests and CI/CD pipelines
# NEW: Uses centralized group-based architecture

- name: Install asdf with lightweight plugins (Centralized Architecture)
  hosts: all
  become: true

  vars:
    # Centralized plugin configuration (NEW v2.0 format)
    asdf_plugins:
      # direnv - Shell extension for environment variables
      # Installation: ~5-10 seconds (shell script only, no compilation)
      - name: "direnv"
        versions:
          - "2.32.3"
        global: "2.32.3"

      # jq - JSON processor  
      # Installation: ~3-5 seconds (pre-compiled binary download)
      - name: "jq"
        versions:
          - "1.7.1"
        global: "1.7.1"

    # Simple user list (NEW v2.0 format)
    asdf_users:
      - "{{ ansible_user }}"

    # Shell configuration (applies to all users)
    asdf_shell_profile: "bashrc"

  roles:
    - role: asdf
      tags: asdf

  post_tasks:
    - name: Verify asdf installation
      ansible.builtin.command: "{{ asdf_install_dir | default('/opt/asdf') }}/bin/asdf version"
      register: asdf_version_check
      changed_when: false
      tags: verify

    - name: List installed plugins (centralized)
      ansible.builtin.command: "{{ asdf_install_dir | default('/opt/asdf') }}/bin/asdf plugin list"
      environment:
        ASDF_DATA_DIR: "{{ asdf_install_dir | default('/opt/asdf') }}"
      register: asdf_plugins
      changed_when: false
      tags: verify

    - name: Test direnv functionality
      ansible.builtin.command: direnv version
      register: direnv_test
      become_user: "{{ ansible_user }}"
      environment:
        PATH: "{{ ansible_env.HOME }}/.asdf/shims:{{ ansible_env.PATH }}"
      changed_when: false
      tags: verify

    - name: Test jq functionality
      ansible.builtin.shell: echo '{"status":"ok"}' | jq .status
      register: jq_test
      become_user: "{{ ansible_user }}"
      environment:
        PATH: "{{ ansible_env.HOME }}/.asdf/shims:{{ ansible_env.PATH }}"
      changed_when: false
      tags: verify

    - name: Display installation summary
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "  asdf Installation Summary"
          - "========================================="
          - "✅ asdf version: {{ asdf_version_check.stdout }}"
          - "✅ Installed plugins: {{ asdf_plugins.stdout_lines | join(', ') }}"
          - "✅ direnv: {{ 'Working' if direnv_test.rc == 0 else 'Failed' }}"
          - "✅ jq: {{ 'Working (' + jq_test.stdout + ')' if jq_test.rc == 0 else 'Failed' }}"
          - "========================================="
      tags: verify
