---
# ==============================================================================
# ASDF BASIC INSTALLATION - LIGHTWEIGHT PLUGINS
# ==============================================================================
# Quick installation with lightweight plugins for testing and CI/CD
# Plugins: direnv, jq, yq (fast installation ~15-30 seconds, no compilation)
# Uses centralized group-based architecture
#
# Documentation: docs/user-guides/asdf/
# ==============================================================================
- name: Install asdf with Lightweight Plugins
  hosts: all
  become: true

  vars:
    # ==========================================================================
    # BASIC CONFIGURATION
    # ==========================================================================
    asdf_version: "latest"
    asdf_install_dir: "/opt/asdf"
    asdf_install_dependencies: true
    asdf_configure_shell: true
    asdf_shell_profile: "bashrc"

    # ==========================================================================
    # USER CONFIGURATION (CENTRALIZED APPROACH)
    # ==========================================================================
    asdf_users:
      - "{{ ansible_user }}"

    # ==========================================================================
    # LIGHTWEIGHT PLUGINS (Fast Installation ~5-15 seconds each)
    # ==========================================================================
    asdf_plugins:
      # direnv - Shell extension for environment variables
      # Installation: ~5-10 seconds (shell script only)
      - name: "direnv"
        versions:
          - "2.35.0"
        global: "2.35.0"

      # jq - JSON processor
      # Installation: ~3-5 seconds (pre-compiled binary)
      - name: "jq"
        versions:
          - "1.7.1"
        global: "1.7.1"

      # yq - YAML processor
      # Installation: ~3-5 seconds (pre-compiled binary)
      - name: "yq"
        versions:
          - "4.44.3"
        global: "4.44.3"

  roles:
    - role: asdf
      tags: asdf

  post_tasks:
    # ==========================================================================
    # VALIDATION
    # ==========================================================================
    - name: Verify asdf installation
      ansible.builtin.command: "{{ asdf_install_dir }}/bin/asdf --version"
      register: asdf_version_check
      changed_when: false
      tags: verify

    - name: List installed plugins
      ansible.builtin.command: "{{ asdf_install_dir }}/bin/asdf plugin list"
      environment:
        ASDF_DIR: "{{ asdf_install_dir }}"
        ASDF_DATA_DIR: "{{ asdf_install_dir }}"
      register: asdf_plugins_list
      changed_when: false
      tags: verify

    - name: Test direnv functionality
      ansible.builtin.command: "{{ asdf_install_dir }}/shims/direnv version"
      register: direnv_test
      environment:
        ASDF_DIR: "{{ asdf_install_dir }}"
        ASDF_DATA_DIR: "{{ asdf_install_dir }}"
      changed_when: false
      failed_when: false
      tags: verify

    - name: Test jq functionality
      ansible.builtin.command: "{{ asdf_install_dir }}/shims/jq --version"
      register: jq_test
      environment:
        ASDF_DIR: "{{ asdf_install_dir }}"
        ASDF_DATA_DIR: "{{ asdf_install_dir }}"
      changed_when: false
      failed_when: false
      tags: verify

    - name: Test yq functionality
      ansible.builtin.command: "{{ asdf_install_dir }}/shims/yq --version"
      register: yq_test
      environment:
        ASDF_DIR: "{{ asdf_install_dir }}"
        ASDF_DATA_DIR: "{{ asdf_install_dir }}"
      changed_when: false
      failed_when: false
      tags: verify

    - name: Display installation summary
      ansible.builtin.debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘           ğŸ‰ ASDF BASIC INSTALLATION COMPLETE! ğŸ‰            â•‘"
          - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          - "â•‘ ğŸ”§ asdf: {{ asdf_version_check.stdout }}"
          - "â•‘ ğŸ“ Install Dir: {{ asdf_install_dir }}"
          - "â•‘ ğŸ‘¤ Users: {{ asdf_users | join(', ') }}"
          - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          - "â•‘ ğŸ”Œ Installed Plugins:                                        â•‘"
          - "â•‘    {{ asdf_plugins_list.stdout_lines | join('\nâ•‘    ') }}"
          - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          - "â•‘ âš¡ Functionality Tests:                                       â•‘"
          - "â•‘    ğŸ“‚ direnv: {{ direnv_test.stdout | default('NOT INSTALLED') }} {{ 'âœ…' if direnv_test.rc == 0 else 'âŒ' }}"
          - "â•‘    ğŸ” jq:     {{ jq_test.stdout | default('NOT INSTALLED') }} {{ 'âœ…' if jq_test.rc == 0 else 'âŒ' }}"
          - "â•‘    ğŸ“„ yq:     {{ yq_test.stdout | default('NOT INSTALLED') }} {{ 'âœ…' if yq_test.rc == 0 else 'âŒ' }}"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      tags: verify
