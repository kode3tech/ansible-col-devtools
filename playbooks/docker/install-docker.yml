---
# ==============================================================================
# DOCKER PRODUCTION INSTALLATION - PERFORMANCE OPTIMIZED
# ==============================================================================
# Production-ready Docker installation with performance optimizations
# Includes custom directories, advanced daemon configuration, and validation
#
# Features:
#   - Custom data directory (recommended: SSD)
#   - overlay2 storage driver with optimizations
#   - High concurrency downloads/uploads
#   - Non-blocking logging with compression
#   - Live restore for zero-downtime updates
#   - Prometheus metrics endpoint
#   - DNS optimization with Cloudflare/Google
#   - BuildKit enabled for faster builds
#   - Time synchronization (critical for GPG keys)
#
# Usage:
#   ansible-playbook playbooks/docker/install-docker.yml -i inventory
#
# For registry authentication, add to vars or create vars file:
#   docker_registries_auth:
#     - registry: "https://index.docker.io/v1/"
#       username: "myuser"
#       password: "{{ vault_dockerhub_token }}"
#
# See: docs/user-guides/DOCKER_COMPLETE_GUIDE.md for complete documentation
# ==============================================================================

- name: Docker Production Installation - Performance Optimized
  hosts: all
  become: true
  
  vars:
    # ==========================================================================
    # BASIC CONFIGURATION
    # ==========================================================================
    docker_edition: "ce"
    # Docker users (add users that need docker access)
    docker_users:
      - "{{ ansible_user }}"
      # - "deploy"
      # - "jenkins"
    
    # ==========================================================================
    # DOCKER DAEMON CONFIGURATION - PERFORMANCE FOCUSED
    # ==========================================================================
    docker_daemon_config:
      # ========================================================================
      # STORAGE & I/O PERFORMANCE
      # ========================================================================
      # Custom directory for better I/O (recommended: SSD)
      data-root: "/opt/docker-data"         # Custom main directory
      exec-root: "/var/run/docker"          # Runtime data
      pidfile: "/var/run/docker.pid"        # Process ID file
      # Optimized storage driver
      storage-driver: "overlay2"
      # storage-opts:
      #   - "overlay2.size=100G"            # 100GB limit per container
      
      # ========================================================================
      # NETWORK PERFORMANCE
      # ========================================================================
      bridge: "docker0"
      iptables: true
      ip-forward: true
      userland-proxy: false                 # CRITICAL: Removes userland proxy
      ip-masq: true                         # IP masquerading
      icc: true                             # Inter-container communication
      
      # ========================================================================
      # CONCURRENCY & DOWNLOADS
      # ========================================================================
      # Maximum performance for downloads/uploads
      max-concurrent-downloads: 25          # High parallelism
      max-concurrent-uploads: 15            # Optimized upload
      max-download-attempts: 5              # Retry on failures
      
      # ========================================================================
      # LOGGING PERFORMANCE
      # ========================================================================
      log-driver: "json-file"
      log-opts:
        max-size: "100m"                    # Larger files = less I/O
        max-file: "5"                       # More files for rotation
        compress: "true"                    # Compression to save space
        mode: "non-blocking"                # Don't block application
        max-buffer-size: "16m"              # Large buffer for high throughput
        labels: "production,service"        # Labels for identification
        
      # ========================================================================
      # RESOURCE LIMITS PRODUCTION
      # ========================================================================
      default-runtime: "runc"
      
      # Shared memory for heavy builds
      default-shm-size: "512M"              # 512MB shared memory
      
      # ========================================================================
      # PRODUCTION RELIABILITY
      # ========================================================================
      # Live restore - containers survive daemon restart
      live-restore: true
      
      # Init process in containers for better cleanup
      init: true
      
      # Production timeouts
      shutdown-timeout: 60                  # 60s for graceful shutdown
      
      # ========================================================================
      # MONITORING & METRICS
      # ========================================================================
      # Prometheus metrics endpoint
      metrics-addr: "127.0.0.1:9323"
      experimental: false                   # Stability > features
      
      # ========================================================================
      # DNS PERFORMANCE
      # ========================================================================
      dns:
        - "1.1.1.1"                         # Cloudflare (fastest)
        - "1.0.0.1"                         # Cloudflare secondary
        - "8.8.8.8"                         # Google primary
        - "8.8.4.4"                         # Google secondary
        
      dns-search:
        - "local"
        # - "prod.internal"
        # - "company.com"
        
      # ========================================================================
      # REGISTRY OPTIMIZATION
      # ========================================================================
      # Registry mirrors for global performance
      registry-mirrors:
        - "https://mirror.gcr.io"
        - "https://docker.mirror.hashicorp.services"
        
      # ========================================================================
      # ADVANCED PRODUCTION FEATURES
      # ========================================================================
      # Cgroup driver (systemd for better integration)
      exec-opts:
        - "native.cgroupdriver=systemd"
        
      # Runtime with cgroup v2 support
      default-address-pools:
        - base: "10.10.0.0/16"              # Custom IP pool
          size: 24                          # /24 subnets
          
      # Advanced features for production
      features:
        buildkit: true
        
    # ==========================================================================
    # ADDITIONAL PERFORMANCE TUNING
    # ==========================================================================
    # BuildKit via environment variable (better control)
    docker_buildkit_enabled: true
    
    # Optimized service configuration
    docker_service_enabled: true
    docker_service_state: started
    
    # ==========================================================================
    # REGISTRIES CONFIGURATION (Examples - uncomment as needed)
    # ==========================================================================
    # Insecure registries for development/test
    # docker_insecure_registries:
    #   - "localhost:5000"
    #   - "registry.internal:5000"
      
    # Registry authentication (use Ansible Vault for passwords!)
    # docker_registries_auth:
    #   - registry: "https://index.docker.io/v1/"
    #     username: "myuser"
    #     password: "{{ vault_dockerhub_token }}"
    #   - registry: "ghcr.io"
    #     username: "github-user"
    #     password: "{{ vault_github_token }}"
    #   - registry: "registry.company.com"
    #     username: "ci-user"
    #     password: "{{ vault_company_registry_token }}"

  # ============================================================================
  # PRE-TASKS - ENVIRONMENT PREPARATION
  # ============================================================================
  pre_tasks:
    # ==========================================================================
    # TIME SYNCHRONIZATION - CRITICAL FOR GPG KEY VALIDATION
    # ==========================================================================
    # --- RedHat-like (RHEL, CentOS, Rocky, AlmaLinux) ---
    - name: "[TimeSync] Ensure chrony is installed (RedHat)"
      ansible.builtin.dnf:
        name: chrony
        state: present
      when: ansible_os_family in ['RedHat', 'Rocky', 'AlmaLinux']
      tags: timesync

    - name: "[TimeSync] Ensure chronyd is enabled and running (RedHat)"
      ansible.builtin.service:
        name: chronyd
        state: started
        enabled: true
      when: ansible_os_family in ['RedHat', 'Rocky', 'AlmaLinux']
      tags: timesync

    - name: "[TimeSync] Force time synchronization (RedHat)"
      ansible.builtin.command:
        cmd: chronyc makestep
      changed_when: false
      when: ansible_os_family in ['RedHat', 'Rocky', 'AlmaLinux']
      tags: timesync

    # --- Debian-like (Debian, Ubuntu) ---
    - name: "[TimeSync] Ensure systemd-timesyncd is installed (Debian)"
      ansible.builtin.apt:
        name: systemd-timesyncd
        state: present
        update_cache: true
        cache_valid_time: 3600
      when: ansible_os_family == 'Debian'
      tags: timesync

    - name: "[TimeSync] Ensure systemd-timesyncd is enabled and running (Debian)"
      ansible.builtin.service:
        name: systemd-timesyncd
        state: started
        enabled: true
      when: ansible_os_family == 'Debian'
      tags: timesync

    - name: "[TimeSync] Force NTP synchronization (Debian)"
      ansible.builtin.command:
        cmd: timedatectl set-ntp true
      changed_when: false
      when: ansible_os_family == 'Debian'
      tags: timesync

    # --- Verification for all systems ---
    - name: "[TimeSync] Wait for time synchronization"
      ansible.builtin.pause:
        seconds: 2
      tags: timesync

    - name: "[TimeSync] Verify time synchronization status"
      ansible.builtin.command:
        cmd: timedatectl show --property=NTPSynchronized --value
      register: timesync_status
      changed_when: false
      failed_when: false
      tags: timesync

    - name: "[TimeSync] Display synchronization status"
      ansible.builtin.debug:
        msg: "â° Time Sync Status: {{ 'SYNCHRONIZED âœ…' if timesync_status.stdout == 'yes' else 'NOT SYNCHRONIZED âš ï¸ (may take a few seconds)' }}"
      tags: timesync

    # ==========================================================================
    # DOCKER DATA DIRECTORY SETUP
    # ==========================================================================
    - name: Create custom Docker data directory
      ansible.builtin.file:
        path: /opt/docker-data
        state: directory
        mode: '0711'
        owner: root
        group: root
        
    # Check if custom directory is a separate mount point
    - name: Check if custom directory is mounted
      ansible.builtin.command: mountpoint -q /opt/docker-data
      register: mountpoint_check
      failed_when: false
      changed_when: false
      
    - name: Display mount status
      ansible.builtin.debug:
        msg: "ğŸ“ Docker data directory {{ 'is mounted as separate filesystem âœ…' if mountpoint_check.rc == 0 else 'is not a separate mount point (consider using SSD)' }}"

  # ============================================================================
  # ROLES EXECUTION
  # ============================================================================
  roles:
    - docker

  # ============================================================================
  # POST-TASKS - VALIDATION AND OPTIMIZATION
  # ============================================================================
  post_tasks:
    # Verify Docker is running
    - name: Verify Docker is running
      ansible.builtin.command: docker info
      register: docker_info_result
      changed_when: false
      
    - name: Display Docker system info
      ansible.builtin.debug:
        msg: "ğŸ³ Docker is running: {{ docker_info_result.stdout_lines[0] }}"
            
    # Basic performance test
    - name: Quick performance test with Alpine
      ansible.builtin.command: docker run --rm alpine:latest echo "Performance test completed"
      register: perf_test
      changed_when: false
      
    - name: Performance test result
      ansible.builtin.debug:
        msg: "ğŸ§ª Container startup test: {{ 'âœ… PASSED' if perf_test.rc == 0 else 'âŒ FAILED' }}"
        
    # Check metrics (if enabled)
    - name: Check if metrics endpoint is responding
      ansible.builtin.uri:
        url: "http://127.0.0.1:9323/metrics"
        method: GET
      register: metrics_check
      failed_when: false
      
    - name: Metrics status
      ansible.builtin.debug:
        msg: "ğŸ“Š Docker Prometheus metrics: {{ 'âœ… Available at http://127.0.0.1:9323/metrics' if metrics_check.status == 200 else 'âš ï¸ Not available (check daemon config)' }}"
        
    # Final summary
    - name: Installation summary
      ansible.builtin.debug:
        msg: |
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ³ DOCKER PRODUCTION INSTALLATION COMPLETE
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          âœ… Docker Engine installed and running
          âœ… overlay2 storage driver configured
          âœ… BuildKit enabled for faster builds
          âœ… Performance optimizations applied:
             â€¢ data-root: /opt/docker-data
             â€¢ max-concurrent-downloads: 25
             â€¢ non-blocking logging
             â€¢ live-restore enabled
             â€¢ userland-proxy disabled
          âœ… Prometheus metrics at http://127.0.0.1:9323/metrics
          
          ğŸ“– Documentation: docs/user-guides/DOCKER_COMPLETE_GUIDE.md
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# ==============================================================================
# PRODUCTION DEPLOYMENT NOTES
# ==============================================================================
#
# 1. STORAGE RECOMMENDATIONS:
#    - Use SSD for /opt/docker-data
#    - Consider separate mount point for Docker data
#    - Monitor disk I/O with tools like iotop
#
# 2. NETWORK OPTIMIZATION:
#    - Disable userland-proxy for better performance
#    - Use bridge networking for most workloads
#    - Consider host networking for high-performance apps
#
# 3. RESOURCE MONITORING:
#    - Monitor with Prometheus metrics endpoint
#    - Watch for container resource usage
#    - Set up alerts for high resource usage
#
# 4. MAINTENANCE:
#    - Regular docker system prune
#    - Monitor log file sizes
#    - Keep Docker daemon updated
#
# 5. SECURITY:
#    - Use non-root containers when possible
#    - Regular security scans
#    - Monitor for CVEs in base images
#    - Use Ansible Vault for registry passwords
#
# ==============================================================================
