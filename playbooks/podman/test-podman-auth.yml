---
# Example playbook: Test Podman authentication with credential cleanup
# This playbook demonstrates how to force re-authentication by cleaning old credentials

- name: Test Podman Authentication with Cleanup
  hosts: all
  become: true

  vars:
    # Enable credential cleanup to remove old/invalid credentials
    podman_clean_credentials: true

    # Podman registry authentication
    # IMPORTANT: Use Ansible Vault to encrypt passwords in production!
    podman_registries_auth:
      - registry: "docker.io"
        username: "your_username"  # Change this
        password: "your_password"  # Change this - use Vault in production!

    # Optional: Rootless configuration
    podman_enable_rootless: false
    podman_rootless_users:
      - "{{ ansible_user }}"

  roles:
    - podman

  post_tasks:
    - name: "=== Verification: Podman Authentication ==="
      ansible.builtin.debug:
        msg: "Testing Podman authentication after credential cleanup..."
      tags: verify

    - name: Check if auth.json exists
      ansible.builtin.stat:
        path: /root/.config/containers/auth.json
      register: auth_file
      tags: verify

    - name: Display auth file status
      ansible.builtin.debug:
        msg: "{{ '✅ Auth file exists - credentials stored' if auth_file.stat.exists else '❌ Auth file missing - login may have failed' }}"
      tags: verify

    - name: Read auth.json content (if exists)
      ansible.builtin.shell: |
        if [ -f /root/.config/containers/auth.json ]; then
          cat /root/.config/containers/auth.json | jq -r '.auths | keys[]' 2>/dev/null || \
          grep -o '"[^"]*":' /root/.config/containers/auth.json | tr -d '":' | head -5
        else
          echo "No auth file found"
        fi
      register: auth_registries
      changed_when: false
      failed_when: false
      tags: verify

    - name: Display authenticated registries
      ansible.builtin.debug:
        msg: "Authenticated registries: {{ auth_registries.stdout_lines }}"
      tags: verify

    - name: Test Podman login without password prompt
      ansible.builtin.shell: |
        export XDG_RUNTIME_DIR=/run/user/0
        echo "Testing podman info for XDG warnings..."
        podman info 2>&1 | grep -i 'warn.*xdg' && echo "⚠️  XDG warning found" || echo "✅ No XDG warnings"
      register: podman_xdg_test
      changed_when: false
      failed_when: false
      tags: verify

    - name: Display Podman XDG test results
      ansible.builtin.debug:
        msg: "{{ podman_xdg_test.stdout_lines }}"
      tags: verify

    - name: Verification summary
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "   PODMAN AUTHENTICATION TEST SUMMARY"
          - "=========================================="
          - "Credential cleanup: {{ 'enabled' if podman_clean_credentials else 'disabled' }}"
          - "Auth file exists: {{ 'yes' if auth_file.stat.exists else 'no' }}"
          - "XDG warnings: {{ 'none' if 'No XDG warnings' in podman_xdg_test.stdout else 'present' }}"
          - "Authenticated registries:"
          - "{{ auth_registries.stdout_lines | join('\n') }}"
          - "=========================================="
      tags: verify
