---
# ==============================================================================
# PODMAN PRODUCTION CONFIGURATION - PERFORMANCE FOCUSED
# ==============================================================================
# Production-optimized Podman configuration with focus on PERFORMANCE
# Includes custom directories, rootless mode, and performance optimizations
#
# ğŸ“– Complete Guide: docs/user-guides/PODMAN_COMPLETE_GUIDE.md
# ==============================================================================
- name: Podman Production Installation - Performance Optimized
  hosts: all
  become: true

  vars:
    # ==========================================================================
    # BASIC CONFIGURATION
    # ==========================================================================
    # Podman packages (includes crun for better performance)
    podman_packages:
      - podman
      - buildah
      - skopeo
      - crun  # 20-30% faster than runc

    # ==========================================================================
    # ROOTLESS CONFIGURATION
    # ==========================================================================
    # Enable rootless mode (more secure)
    podman_enable_rootless: true

    # Unprivileged test user for rootless validation
    # This user will be created automatically to test rootless mode
    podman_test_user: "podman-test"

    # Users to configure for rootless Podman
    podman_rootless_users:
      - "{{ ansible_user }}"
      - "{{ podman_test_user }}"
      # Add your users here:
      # - "deploy"
      # - "jenkins"
      # - "developer"

    # Subuid/subgid ranges for rootless (each user gets 65536 IDs)
    podman_subuid_start: 100000
    podman_subuid_count: 65536
    podman_subgid_start: 100000
    podman_subgid_count: 65536

    # ==========================================================================
    # REGISTRIES CONFIGURATION
    # ==========================================================================
    # Registries for unqualified image search
    podman_registries_conf:
      unqualified-search-registries:
        - docker.io
        - quay.io
        - ghcr.io

    # Insecure registries (HTTP or self-signed certificates)
    # WARNING: Only for trusted internal networks!
    podman_insecure_registries: []
      # - "localhost:5000"
      # - "registry.internal.company.com:5000"

    # ==========================================================================
    # REGISTRY AUTHENTICATION
    # ==========================================================================
    # Private registry authentication
    # IMPORTANT: Always use Ansible Vault for passwords!
    #
    # Example with Ansible Vault:
    #   ansible-vault create vars/registry_secrets.yml
    #   # Add: vault_dockerhub_token: "your-token"
    #
    # Then reference in playbook:
    #   vars_files:
    #     - vars/registry_secrets.yml
    #
    podman_registries_auth: []
      # - registry: "docker.io"
      #   username: "your-username"
      #   password: "{{ vault_dockerhub_token }}"
      #
      # - registry: "quay.io"
      #   username: "your-username"
      #   password: "{{ vault_quay_token }}"
      #
      # - registry: "ghcr.io"
      #   username: "github-user"
      #   password: "{{ vault_github_token }}"
      #
      # - registry: "registry.company.com"
      #   username: "prod-deploy"
      #   password: "{{ vault_company_registry_token }}"

    # Clean old credentials before re-authentication
    podman_clean_credentials: false

    # ==========================================================================
    # STORAGE CONFIGURATION - PERFORMANCE FOCUSED
    # ==========================================================================
    podman_storage_conf:
      storage:
        # Optimized storage driver
        driver: "overlay"
        # Runtime directory (tmpfs for better I/O)
        runroot: "/run/containers/storage"
        # Custom main directory (SSD recommended)
        graphroot: "/opt/podman-data/storage"
        options:
          overlay:
            # metacopy=on reduces I/O operations (+30-50% performance)
            mountopt: "nodev,metacopy=on"

      # =======================================================================
      # ENGINE CONFIGURATION - PERFORMANCE TUNING
      # =======================================================================
      engine:
        # crun runtime: 20-30% faster than runc
        runtime: "crun"
        # Events logger
        events_logger: "file"
        # Cgroup manager (systemd for better integration)
        cgroup_manager: "systemd"
        # Number of locks for concurrent operations
        num_locks: 2048
        # Parallel layer downloads (maximum performance)
        image_parallel_copies: 10

    # Reset storage on driver conflict
    # WARNING: DELETES ALL CONTAINERS/IMAGES!
    podman_reset_storage_on_driver_change: false

  # ==========================================================================
  # PRE-TASKS - ENVIRONMENT PREPARATION
  # ==========================================================================
  pre_tasks:
    # ==========================================================================
    # TIME SYNCHRONIZATION - CRITICAL FOR GPG KEY VALIDATION
    # ==========================================================================
    # --- RedHat-like (RHEL, CentOS, Rocky, AlmaLinux) ---
    - name: "[TimeSync] Ensure chrony is installed (RedHat)"
      ansible.builtin.dnf:
        name: chrony
        state: present
      when: ansible_os_family in ['RedHat', 'Rocky', 'AlmaLinux']
      tags: timesync

    - name: "[TimeSync] Ensure chronyd is enabled and running (RedHat)"
      ansible.builtin.service:
        name: chronyd
        state: started
        enabled: true
      when: ansible_os_family in ['RedHat', 'Rocky', 'AlmaLinux']
      tags: timesync

    - name: "[TimeSync] Force time synchronization (RedHat)"
      ansible.builtin.command:
        cmd: chronyc makestep
      changed_when: false
      when: ansible_os_family in ['RedHat', 'Rocky', 'AlmaLinux']
      tags: timesync

    # --- Debian-like (Debian, Ubuntu) ---
    - name: "[TimeSync] Ensure systemd-timesyncd is installed (Debian)"
      ansible.builtin.apt:
        name: systemd-timesyncd
        state: present
        update_cache: true
        cache_valid_time: 3600
      when: ansible_os_family == 'Debian'
      tags: timesync

    - name: "[TimeSync] Ensure systemd-timesyncd is enabled and running (Debian)"
      ansible.builtin.service:
        name: systemd-timesyncd
        state: started
        enabled: true
      when: ansible_os_family == 'Debian'
      tags: timesync

    - name: "[TimeSync] Force NTP synchronization (Debian)"
      ansible.builtin.command:
        cmd: timedatectl set-ntp true
      changed_when: false
      when: ansible_os_family == 'Debian'
      tags: timesync

    # --- Verification for all systems ---
    - name: "[TimeSync] Wait for time synchronization"
      ansible.builtin.pause:
        seconds: 2
      tags: timesync

    - name: "[TimeSync] Verify time synchronization status"
      ansible.builtin.command:
        cmd: timedatectl show --property=NTPSynchronized --value
      register: timesync_status
      changed_when: false
      failed_when: false
      tags: timesync

    - name: "[TimeSync] Display synchronization status"
      ansible.builtin.debug:
        msg: "â° Time Sync Status: {{ 'SYNCHRONIZED âœ…' if timesync_status.stdout == 'yes' else 'NOT SYNCHRONIZED âš ï¸ (may take a few seconds)' }}"
      tags: timesync

    # ==========================================================================
    # PODMAN DATA DIRECTORY SETUP
    # ==========================================================================
    # Create custom Podman directory
    - name: Create custom Podman data directory
      ansible.builtin.file:
        path: /opt/podman-data
        state: directory
        mode: '0711'
        owner: root
        group: root

    - name: Create custom Podman storage directory
      ansible.builtin.file:
        path: /opt/podman-data/storage
        state: directory
        mode: '0711'
        owner: root
        group: root

    # Check mount point (for dedicated SSD)
    - name: Check if custom directory is mounted
      ansible.builtin.command: mountpoint -q /opt/podman-data
      register: mountpoint_check
      failed_when: false
      changed_when: false

    - name: Display mount status
      ansible.builtin.debug:
        msg: "Podman data directory {{ 'is mounted' if mountpoint_check.rc == 0 else 'is not mounted' }} as separate filesystem"

    # ==========================================================================
    # CREATE UNPRIVILEGED TEST USER FOR ROOTLESS PODMAN
    # ==========================================================================
    - name: "[TestUser] Create unprivileged user for rootless Podman testing"
      ansible.builtin.user:
        name: "{{ podman_test_user }}"
        comment: "Podman Rootless Test User (no admin privileges)"
        shell: /bin/bash
        create_home: true
        state: present
      tags: testuser

    - name: "[TestUser] Ensure test user is NOT in sudo/wheel group"
      ansible.builtin.user:
        name: "{{ podman_test_user }}"
        groups: []
        append: false
      tags: testuser

    - name: "[TestUser] Get test user UID"
      ansible.builtin.command: id -u {{ podman_test_user }}
      register: test_user_uid
      changed_when: false
      tags: testuser

    - name: "[TestUser] Display test user info"
      ansible.builtin.debug:
        msg: "ğŸ‘¤ Created unprivileged user: {{ podman_test_user }} (UID: {{ test_user_uid.stdout }})"
      tags: testuser

  # ==========================================================================
  # ROLES EXECUTION
  # ==========================================================================
  roles:
    - podman

  # ==========================================================================
  # POST-TASKS - VALIDATION AND OPTIMIZATION
  # ==========================================================================
  post_tasks:
    # ==========================================================================
    # BASIC VALIDATION
    # ==========================================================================
    # Verify Podman is installed
    - name: Verify Podman is installed
      ansible.builtin.command: podman --version
      register: podman_version_result
      changed_when: false

    - name: Display Podman version
      ansible.builtin.debug:
        msg: "ğŸ³ {{ podman_version_result.stdout }}"

    # Verify Buildah
    - name: Verify Buildah is installed
      ansible.builtin.command: buildah --version
      register: buildah_version_result
      changed_when: false

    - name: Display Buildah version
      ansible.builtin.debug:
        msg: "ğŸ—ï¸ {{ buildah_version_result.stdout }}"

    # Verify Skopeo
    - name: Verify Skopeo is installed
      ansible.builtin.command: skopeo --version
      register: skopeo_version_result
      changed_when: false

    - name: Display Skopeo version
      ansible.builtin.debug:
        msg: "ğŸ“¦ {{ skopeo_version_result.stdout }}"

    # ==========================================================================
    # SYSTEM INFO
    # ==========================================================================
    - name: Get Podman system info
      ansible.builtin.command: podman info --format json
      register: podman_info_result
      changed_when: false

    - name: Parse Podman info
      ansible.builtin.set_fact:
        podman_info: "{{ podman_info_result.stdout | from_json }}"

    - name: Display Podman system info
      ansible.builtin.debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘                    PODMAN SYSTEM INFO                        â•‘"
          - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          - "â•‘ ğŸ”§ Runtime:        {{ podman_info.host.ociRuntime.name | default('unknown') }}"
          - "â•‘ ğŸ’¾ Storage Driver: {{ podman_info.store.graphDriverName | default('unknown') }}"
          - "â•‘ ğŸ“ Graph Root:     {{ podman_info.store.graphRoot | default('unknown') }}"
          - "â•‘ ğŸƒ Run Root:       {{ podman_info.store.runRoot | default('unknown') }}"
          - "â•‘ ğŸ§ OS:             {{ podman_info.host.os | default('unknown') }}"
          - "â•‘ ğŸ–¥ï¸  Kernel:         {{ podman_info.host.kernel | default('unknown') }}"
          - "â•‘ ğŸ” Rootless:       {{ podman_info.host.security.rootless | default('unknown') }}"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    # ==========================================================================
    # RUNTIME VALIDATION
    # ==========================================================================
    # Check if crun is available
    - name: Check if crun is available
      ansible.builtin.command: which crun
      register: crun_check
      failed_when: false
      changed_when: false

    - name: Get crun version
      ansible.builtin.command: crun --version
      register: crun_version
      when: crun_check.rc == 0
      changed_when: false

    - name: Display runtime status
      ansible.builtin.debug:
        msg: "âš¡ Runtime: {{ 'crun ' ~ (crun_version.stdout_lines[0] | default('')) ~ ' (HIGH PERFORMANCE âœ…)' if crun_check.rc == 0 else 'runc (standard)' }}"

    # ==========================================================================
    # CONTAINER TEST - PULL AND RUN IMAGES (ROOTLESS MODE)
    # ==========================================================================
    # Tests run as ansible_user (rootless) unless ansible_user is root
    # --- Get ansible_user UID (needed for XDG_RUNTIME_DIR) ---
    - name: Get ansible_user UID
      ansible.builtin.command: id -u {{ ansible_user }}
      register: ansible_user_uid_result
      changed_when: false

    - name: Set ansible_user_uid_real fact
      ansible.builtin.set_fact:
        ansible_user_uid_real: "{{ ansible_user_uid_result.stdout }}"

    # --- Ensure XDG_RUNTIME_DIR exists for ansible_user ---
    - name: Ensure XDG_RUNTIME_DIR exists for ansible_user
      ansible.builtin.file:
        path: "/run/user/{{ ansible_user_uid_real }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0700'

    # --- Pull Alpine Image (as ansible_user) ---
    - name: Pull Alpine image (rootless)
      ansible.builtin.command: podman pull docker.io/library/alpine:latest
      become: true
      become_user: "{{ ansible_user }}"
      register: alpine_pull
      changed_when: "'Storing signatures' in alpine_pull.stdout or 'Writing manifest' in alpine_pull.stdout"
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ ansible_user_uid_real }}"

    - name: Display Alpine pull status
      ansible.builtin.debug:
        msg: "ğŸ”ï¸ Alpine image ({{ ansible_user }}): {{ 'PULLED âœ…' if alpine_pull.rc == 0 else 'FAILED âŒ' }}"

    # --- Pull hello-world Image (as ansible_user) ---
    - name: Pull hello-world image (rootless)
      ansible.builtin.command: podman pull docker.io/library/hello-world:latest
      become: true
      become_user: "{{ ansible_user }}"
      register: helloworld_pull
      changed_when: "'Storing signatures' in helloworld_pull.stdout or 'Writing manifest' in helloworld_pull.stdout"
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ ansible_user_uid_real }}"

    - name: Display hello-world pull status
      ansible.builtin.debug:
        msg: "ğŸ‘‹ hello-world image ({{ ansible_user }}): {{ 'PULLED âœ…' if helloworld_pull.rc == 0 else 'FAILED âŒ' }}"

    # --- Run Alpine Container Test (as ansible_user) ---
    - name: Run Alpine container test (rootless)
      ansible.builtin.command: podman run --rm docker.io/library/alpine:latest echo "Alpine container test - SUCCESS"
      become: true
      become_user: "{{ ansible_user }}"
      register: alpine_run
      changed_when: false
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ ansible_user_uid_real }}"

    - name: Display Alpine run result
      ansible.builtin.debug:
        msg: "ğŸ”ï¸ Alpine container run ({{ ansible_user }}): {{ 'PASSED âœ…' if alpine_run.rc == 0 else 'FAILED âŒ' }} - {{ alpine_run.stdout | default('') }}"

    # --- Run hello-world Container Test (as ansible_user) ---
    - name: Run hello-world container test (rootless)
      ansible.builtin.command: podman run --rm docker.io/library/hello-world:latest
      become: true
      become_user: "{{ ansible_user }}"
      register: helloworld_run
      changed_when: false
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ ansible_user_uid_real }}"

    - name: Display hello-world run result
      ansible.builtin.debug:
        msg: "ğŸ‘‹ hello-world container run ({{ ansible_user }}): {{ 'PASSED âœ…' if helloworld_run.rc == 0 else 'FAILED âŒ' }}"

    # --- Show hello-world output ---
    - name: Show hello-world output
      ansible.builtin.debug:
        msg: "{{ helloworld_run.stdout_lines | default(['No output']) }}"
      when: helloworld_run.rc == 0

    # --- List downloaded images (as ansible_user) ---
    - name: List downloaded images (rootless)
      ansible.builtin.command: podman images --format "table {{ '{{' }}.Repository{{ '}}' }}\t{{ '{{' }}.Tag{{ '}}' }}\t{{ '{{' }}.Size{{ '}}' }}"
      become: true
      become_user: "{{ ansible_user }}"
      register: podman_images
      changed_when: false
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ ansible_user_uid_real }}"

    - name: Display downloaded images
      ansible.builtin.debug:
        msg:
          - "ğŸ“¦ Downloaded Images ({{ ansible_user }}):"
          - "{{ podman_images.stdout_lines }}"

    # --- Performance test summary ---
    - name: Container tests summary
      ansible.builtin.debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘           CONTAINER TESTS SUMMARY (ROOTLESS MODE)            â•‘"
          - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          - "â•‘ ğŸ‘¤ User:             {{ ansible_user }}"
          - "â•‘ ğŸ”ï¸ Alpine pull:      {{ 'PASSED âœ…' if alpine_pull.rc == 0 else 'FAILED âŒ' }}                                    â•‘"
          - "â•‘ ğŸ‘‹ hello-world pull: {{ 'PASSED âœ…' if helloworld_pull.rc == 0 else 'FAILED âŒ' }}                                â•‘"
          - "â•‘ ğŸ”ï¸ Alpine run:       {{ 'PASSED âœ…' if alpine_run.rc == 0 else 'FAILED âŒ' }}                                     â•‘"
          - "â•‘ ğŸ‘‹ hello-world run:  {{ 'PASSED âœ…' if helloworld_run.rc == 0 else 'FAILED âŒ' }}                                 â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    # ==========================================================================
    # UNPRIVILEGED USER ROOTLESS TEST
    # ==========================================================================
    # Test Podman rootless with a user that has NO administrative privileges
    # This validates that rootless mode works for regular users
    - name: "[UnprivilegedTest] Display test user info"
      ansible.builtin.debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘     UNPRIVILEGED USER ROOTLESS TEST ({{ podman_test_user }})              â•‘"
          - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          - "â•‘ Testing Podman rootless with user WITHOUT sudo/admin access  â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      tags: rootless-test

    # --- Ensure XDG_RUNTIME_DIR exists for test user ---
    - name: "[UnprivilegedTest] Ensure XDG_RUNTIME_DIR exists for test user"
      ansible.builtin.file:
        path: "/run/user/{{ test_user_uid.stdout }}"
        state: directory
        owner: "{{ podman_test_user }}"
        group: "{{ podman_test_user }}"
        mode: '0700'
      tags: rootless-test

    # --- Pull Alpine Image (as unprivileged user) ---
    - name: "[UnprivilegedTest] Pull Alpine image"
      ansible.builtin.command: podman pull docker.io/library/alpine:latest
      become: true
      become_user: "{{ podman_test_user }}"
      register: unpriv_alpine_pull
      changed_when: "'Storing signatures' in unpriv_alpine_pull.stdout or 'Writing manifest' in unpriv_alpine_pull.stdout"
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ test_user_uid.stdout }}"
      tags: rootless-test

    - name: "[UnprivilegedTest] Display Alpine pull status"
      ansible.builtin.debug:
        msg: "ğŸ”ï¸ Alpine image ({{ podman_test_user }}): {{ 'PULLED âœ…' if unpriv_alpine_pull.rc == 0 else 'FAILED âŒ' }}"
      tags: rootless-test

    # --- Pull hello-world Image (as unprivileged user) ---
    - name: "[UnprivilegedTest] Pull hello-world image"
      ansible.builtin.command: podman pull docker.io/library/hello-world:latest
      become: true
      become_user: "{{ podman_test_user }}"
      register: unpriv_helloworld_pull
      changed_when: "'Storing signatures' in unpriv_helloworld_pull.stdout or 'Writing manifest' in unpriv_helloworld_pull.stdout"
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ test_user_uid.stdout }}"
      tags: rootless-test

    - name: "[UnprivilegedTest] Display hello-world pull status"
      ansible.builtin.debug:
        msg: "ğŸ‘‹ hello-world image ({{ podman_test_user }}): {{ 'PULLED âœ…' if unpriv_helloworld_pull.rc == 0 else 'FAILED âŒ' }}"
      tags: rootless-test

    # --- Run Alpine Container (as unprivileged user) ---
    - name: "[UnprivilegedTest] Run Alpine container"
      ansible.builtin.command: podman run --rm docker.io/library/alpine:latest echo "Rootless test SUCCESS - I am $(whoami)"
      become: true
      become_user: "{{ podman_test_user }}"
      register: unpriv_alpine_run
      changed_when: false
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ test_user_uid.stdout }}"
      tags: rootless-test

    - name: "[UnprivilegedTest] Display Alpine run result"
      ansible.builtin.debug:
        msg: "ğŸ”ï¸ Alpine run ({{ podman_test_user }}): {{ 'PASSED âœ…' if unpriv_alpine_run.rc == 0 else 'FAILED âŒ' }} - {{ unpriv_alpine_run.stdout | default('') }}"
      tags: rootless-test

    # --- Run hello-world Container (as unprivileged user) ---
    - name: "[UnprivilegedTest] Run hello-world container"
      ansible.builtin.command: podman run --rm docker.io/library/hello-world:latest
      become: true
      become_user: "{{ podman_test_user }}"
      register: unpriv_helloworld_run
      changed_when: false
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ test_user_uid.stdout }}"
      tags: rootless-test

    - name: "[UnprivilegedTest] Display hello-world run result"
      ansible.builtin.debug:
        msg: "ğŸ‘‹ hello-world run ({{ podman_test_user }}): {{ 'PASSED âœ…' if unpriv_helloworld_run.rc == 0 else 'FAILED âŒ' }}"
      tags: rootless-test

    # --- List images (as unprivileged user) ---
    - name: "[UnprivilegedTest] List downloaded images"
      ansible.builtin.command: podman images --format "table {{ '{{' }}.Repository{{ '}}' }}\t{{ '{{' }}.Tag{{ '}}' }}\t{{ '{{' }}.Size{{ '}}' }}"
      become: true
      become_user: "{{ podman_test_user }}"
      register: unpriv_podman_images
      changed_when: false
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ test_user_uid.stdout }}"
      tags: rootless-test

    - name: "[UnprivilegedTest] Display downloaded images"
      ansible.builtin.debug:
        msg:
          - "ğŸ“¦ Downloaded Images ({{ podman_test_user }}):"
          - "{{ unpriv_podman_images.stdout_lines }}"
      tags: rootless-test

    # --- Verify user has NO sudo access ---
    - name: "[UnprivilegedTest] Verify user has NO sudo access"
      ansible.builtin.command: sudo -n true
      become: true
      become_user: "{{ podman_test_user }}"
      register: sudo_check
      failed_when: false
      changed_when: false
      tags: rootless-test

    - name: "[UnprivilegedTest] Display sudo access status"
      ansible.builtin.debug:
        msg: "ğŸ”’ Sudo access: {{ 'HAS SUDO âš ï¸' if sudo_check.rc == 0 else 'NO SUDO âœ… (unprivileged user confirmed)' }}"
      tags: rootless-test

    # --- Unprivileged User Test Summary ---
    - name: "[UnprivilegedTest] Test summary"
      ansible.builtin.debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘        UNPRIVILEGED USER ROOTLESS TEST SUMMARY               â•‘"
          - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          - "â•‘ ğŸ‘¤ User:             {{ podman_test_user }} (UID: {{ test_user_uid.stdout }})"
          - "â•‘ ğŸ”’ Sudo access:      {{ 'YES âš ï¸' if sudo_check.rc == 0 else 'NO âœ…' }}"
          - "â•‘ ğŸ”ï¸ Alpine pull:      {{ 'PASSED âœ…' if unpriv_alpine_pull.rc == 0 else 'FAILED âŒ' }}      â•‘"
          - "â•‘ ğŸ‘‹ hello-world pull: {{ 'PASSED âœ…' if unpriv_helloworld_pull.rc == 0 else 'FAILED âŒ' }}  â•‘"
          - "â•‘ ğŸ”ï¸ Alpine run:       {{ 'PASSED âœ…' if unpriv_alpine_run.rc == 0 else 'FAILED âŒ' }}       â•‘"
          - "â•‘ ğŸ‘‹ hello-world run:  {{ 'PASSED âœ…' if unpriv_helloworld_run.rc == 0 else 'FAILED âŒ' }}   â•‘"
          - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          - "â•‘ ğŸ‰ ROOTLESS MODE VALIDATED FOR UNPRIVILEGED USER!            â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      tags: rootless-test

    # ==========================================================================
    # ROOTLESS VALIDATION
    # ==========================================================================
    - name: Verify rootless configuration
      ansible.builtin.command: "grep {{ item }} /etc/subuid"
      loop: "{{ podman_rootless_users }}"
      register: subuid_check
      failed_when: false
      changed_when: false
      when: podman_rootless_users | length > 0

    - name: Display rootless status
      ansible.builtin.debug:
        msg: "ğŸ‘¤ Rootless users configured: {{ podman_rootless_users | join(', ') }}"
      when: podman_rootless_users | length > 0

    # ==========================================================================
    # STORAGE VALIDATION
    # ==========================================================================
    - name: Check storage configuration
      ansible.builtin.stat:
        path: /etc/containers/storage.conf
      register: storage_conf_stat

    - name: Display storage config status
      ansible.builtin.debug:
        msg: "ğŸ“„ Storage config: {{ 'Configured âœ…' if storage_conf_stat.stat.exists else 'Not found âŒ' }}"

    # ==========================================================================
    # REGISTRIES VALIDATION
    # ==========================================================================
    - name: Check registries configuration
      ansible.builtin.stat:
        path: /etc/containers/registries.conf
      register: registries_conf_stat

    - name: Display registries config status
      ansible.builtin.debug:
        msg: "ğŸŒ Registries config: {{ 'Configured âœ…' if registries_conf_stat.stat.exists else 'Not found âŒ' }}"

    # ==========================================================================
    # FINAL SUMMARY
    # ==========================================================================
    - name: Display final summary
      ansible.builtin.debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘             ğŸ‰ PODMAN INSTALLATION COMPLETE! ğŸ‰              â•‘"
          - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          - "â•‘                                                              â•‘"
          - "â•‘ âœ… Podman installed and configured                          â•‘"
          - "â•‘ âœ… Buildah and Skopeo available                             â•‘"
          - "â•‘ âœ… Storage optimized (overlay + metacopy)                   â•‘"
          - "â•‘ âœ… crun runtime for maximum performance                     â•‘"
          - "â•‘ âœ… Rootless mode enabled for security                       â•‘"
          - "â•‘                                                              â•‘"
          - "â•‘ ğŸ“Š Performance Gains:                                        â•‘"
          - "â•‘    â€¢ +30-50% I/O with metacopy                               â•‘"
          - "â•‘    â€¢ +20-30% startup with crun                               â•‘"
          - "â•‘    â€¢ +200-300% pulls with parallel copies                    â•‘"
          - "â•‘                                                              â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# ==============================================================================
# PRODUCTION DEPLOYMENT NOTES - PODMAN
# ==============================================================================
#
# ğŸ“– COMPLETE GUIDE: docs/user-guides/PODMAN_COMPLETE_GUIDE.md
#
# 1. ROOTLESS vs ROOT MODE:
#    - Rootless: More secure, per-user containers, recommended
#    - Root: System-wide, higher performance, use for system services
#
# 2. STORAGE RECOMMENDATIONS:
#    - Use SSD for /opt/podman-data
#    - Consider separate mount point for container data
#    - overlay driver with metacopy=on for best performance
#
# 3. crun vs runc:
#    - crun: 20-30% faster startup, 30-50% lower memory
#    - crun: Written in C (runc is Go)
#    - crun: Better for high-density workloads
#
# 4. REGISTRY TIPS:
#    - Use docker.io for Docker Hub images
#    - Use quay.io for Red Hat images
#    - Configure mirrors for production
#    - ALWAYS use Ansible Vault for passwords!
#
# 5. DOCKER COMPATIBILITY:
#    - Podman is Docker CLI compatible
#    - alias docker=podman works perfectly
#    - Same Dockerfile/Containerfile syntax
#
# 6. SECURITY:
#    - Rootless mode by default
#    - No daemon = smaller attack surface
#    - SELinux integration on RHEL
#
# 7. MAINTENANCE:
#    - podman system prune for cleanup
#    - podman system reset for full reset
#    - Monitor /opt/podman-data space
#
# ==============================================================================
